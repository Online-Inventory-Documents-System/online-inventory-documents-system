<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* small modal & table helpers */
    .modal { position: fixed; left:0; right:0; top:0; bottom:0; display:none; background: rgba(0,0,0,0.45); z-index: 9999; }
    .modal.show { display:block; }
    .modal-inner { margin: 40px auto; max-width: 920px; background: var(--card-light); padding: 18px; border-radius: 8px; box-shadow: var(--shadow-md); }
    .row-grid { display:grid; grid-template-columns: 1fr 200px; gap:12px; align-items:center; }
    .items-table { width:100%; border-collapse: collapse; margin-top:8px; }
    .items-table th, .items-table td { padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:left; }
    .items-table input, .items-table select { width:100%; box-sizing:border-box; padding:6px; }
    .small { font-size:0.95rem; }
    .action-btns { display:flex; gap:6px; }
    .inline-btn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
    .btn-add { background:var(--success-color); color:#fff; }
    .btn-danger { background:var(--danger-color); color:#fff; }
    .btn-primary { background:var(--primary-color); color:#fff; }
    .right { text-align:right; }
    .muted { color:var(--secondary-color); font-size:0.95rem; }
  </style>
</head>
<body>
<header>
  <h1>üßæ Orders</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="inventory.html">Inventory</a>
    <a href="documents.html">Documents</a>
    <a href="log.html">Activity Log</a>
    <a href="sales.html">Sales</a>
    <a href="orders.html" class="active">Orders</a>
    <a href="company.html">Company</a>
    <a href="setting.html" style="text-decoration:none;"><button>‚öôÔ∏è Setting</button></a>
    <button onclick="toggleTheme()">üåì Mode</button>
    <button onclick="logout()">üö™ Logout</button>
    <div id="adminInfo">Logged in as: <span id="adminName"></span> (<span id="adminRole"></span>)</div>
  </nav>
</header>

<main>
  <section>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2>Order Records</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="downloadOrdersXLSXBtnInline" class="success-btn">‚¨áÔ∏è Excel</button>
        <button id="downloadOrdersPDFBtn" class="secondary-btn">‚¨áÔ∏è PDF</button>
        <button id="createOrderBtn" class="primary-btn">‚ûï New Order</button>
      </div>
    </div>

    <div class="table-container">
      <table id="ordersTable" class="small">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Customer</th>
            <th>Items</th>
            <th class="money">Total (RM)</th>
            <th>Status</th>
            <th>Date</th>
            <th class="actions">Actions</th>
          </tr>
        </thead>
        <tbody id="ordersList"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Add / Edit Order Modal (same modal used for create & edit) -->
<div id="orderModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-inner" role="document">
    <h3 id="modalTitle">New Order</h3>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
      <div style="flex:1;">
        <label>Customer Name</label>
        <input id="orderCustomer" placeholder="Customer full name" />
      </div>
      <div style="width:180px;">
        <label>Status</label>
        <select id="orderStatus">
          <option>Pending</option>
          <option>Approved</option>
          <option>Cancelled</option>
        </select>
      </div>
    </div>

    <div>
      <label>Items</label>
      <table class="items-table">
        <thead>
          <tr>
            <th style="width:40%;">Product</th>
            <th style="width:12%;">SKU</th>
            <th style="width:10%;">Qty</th>
            <th style="width:14%;">Unit Price (RM)</th>
            <th style="width:14%;">Line Total (RM)</th>
            <th style="width:10%;"> </th>
          </tr>
        </thead>
        <tbody id="orderItemsBody"></tbody>
      </table>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
        <div>
          <button id="addItemRowBtn" class="inline-btn btn-add">+ Add Item</button>
          <span class="muted" style="margin-left:8px;">Select product to auto-fill SKU & price</span>
        </div>
        <div style="min-width:260px;">
          <div style="display:flex;justify-content:space-between;"><div>Subtotal</div><div id="subtotalText" class="right">RM 0.00</div></div>
          <div style="display:flex;justify-content:space-between;margin-top:6px;"><div>Tax (%)</div><div id="taxText" class="right">0</div></div>
          <div style="display:flex;justify-content:space-between;margin-top:6px;font-weight:700;"><div>Grand Total</div><div id="grandTotalText" class="right">RM 0.00</div></div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button id="modalCancelBtn" class="secondary-btn">Cancel</button>
      <button id="modalSaveBtn" class="primary-btn">Save Order</button>
    </div>
  </div>
</div>

<script src="js/setting.js" defer></script>
<script src="js/script.js" defer></script>

<script>
/*
  Orders page script
  - Uses existing global API_BASE from public/js/script.js
  - Tries to load products from /api/products; falls back to /api/inventory.
*/

document.documentElement.dataset.page = 'orders';

let PRODUCTS = []; // { name, sku, price }
let ORDERS = [];
let editingOrderId = null;

// util (re-usable from script.js)
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const adminRole = sessionStorage.getItem('adminRole') || sessionStorage.getItem('role') || 'staff';
const adminName = sessionStorage.getItem('adminName') || 'Guest';

// prefill header info
document.addEventListener('DOMContentLoaded', () => {
  if (qs('#adminName')) qs('#adminName').textContent = adminName;
  if (qs('#adminRole')) qs('#adminRole').textContent = adminRole;

  bindPageActions();
  loadProducts().then(() => loadOrders());
});

// ------------------ PRODUCTS ------------------
async function loadProducts(){
  // Try /api/products then fallback to /api/inventory
  try {
    let res = await fetch(`${API_BASE}/products`);
    if (!res.ok) throw new Error('no /api/products');
    const data = await res.json();
    PRODUCTS = (Array.isArray(data) ? data : []).map(p => ({ name: p.name || p.productName || p.title || p.sku || '', sku: p.sku || p.id || p._id || '', price: Number(p.price || p.unitPrice || p.unit_cost || 0) }));
    if (PRODUCTS.length) return;
  } catch (err) {
    // fallback
  }
  try {
    const res2 = await fetch(`${API_BASE}/inventory`);
    if (!res2.ok) { PRODUCTS = []; return; }
    const inv = await res2.json();
    PRODUCTS = (Array.isArray(inv) ? inv : []).map(p => ({ name: p.name || '', sku: p.sku || p.id || '', price: Number(p.unitPrice || p.unit_price || p.unitCost || 0) }));
  } catch (err) {
    console.error('Failed to load products fallback', err);
    PRODUCTS = [];
  }
}

// ------------------ ORDERS ------------------
async function loadOrders(){
  try {
    const res = await fetch(`${API_BASE}/orders`);
    if (!res.ok) throw new Error('Failed to fetch orders');
    ORDERS = await res.json();
    renderOrdersTable();
  } catch (err) {
    console.error('loadOrders error', err);
    ORDERS = [];
    renderOrdersTable();
  }
}

function renderOrdersTable(){
  const tbody = qs('#ordersList');
  tbody.innerHTML = '';
  ORDERS.forEach(o => {
    const tr = document.createElement('tr');
    const itemsCount = Array.isArray(o.items) ? o.items.length : 0;
    const total = (Number(o.total) || 0).toFixed(2);
    const dateStr = o.date ? new Date(o.date).toLocaleString() : '';
    const orderId = o.id || o._id || o.orderNumber;

    tr.innerHTML = `
      <td>${escapeHtml(o.orderNumber || orderId)}</td>
      <td>${escapeHtml(o.customerName || '')}</td>
      <td>${itemsCount}</td>
      <td class="money">RM ${total}</td>
      <td>${escapeHtml(o.status || '')}</td>
      <td>${escapeHtml(dateStr)}</td>
      <td class="actions">
        <div class="action-btns">
          <button class="inline-btn btn-primary" onclick="viewInvoice('${orderId}')">üìÑ Invoice</button>
          <button class="inline-btn" onclick="openEditOrder('${orderId}')">‚úèÔ∏è Edit</button>
          ${ (adminRole === 'admin') ? `<button class="inline-btn btn-danger" onclick="deleteOrderConfirmed('${orderId}')">üóëÔ∏è Delete</button>` : '' }
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ------------------ MODAL / ORDER FORM ------------------
function bindPageActions(){
  qs('#createOrderBtn')?.addEventListener('click', ()=> openNewOrderModal());
  qs('#modalCancelBtn')?.addEventListener('click', ()=> closeOrderModal());
  qs('#modalSaveBtn')?.addEventListener('click', ()=> saveOrder());
  qs('#addItemRowBtn')?.addEventListener('click', ()=> addItemRow());
  qs('#downloadOrdersPDFBtn')?.addEventListener('click', ()=> window.open(`${API_BASE}/orders/report/pdf`, '_blank'));
  qs('#downloadOrdersXLSXBtnInline')?.addEventListener('click', ()=> window.open(`${API_BASE}/orders/report`, '_blank'));
}

function openNewOrderModal(){
  editingOrderId = null;
  qs('#modalTitle').textContent = 'Create New Order';
  qs('#orderCustomer').value = '';
  qs('#orderStatus').value = 'Pending';
  qs('#orderItemsBody').innerHTML = '';
  addItemRow();
  recalcTotals();
  showModal('orderModal');
}

function openEditOrder(idOrNumber){
  // find order by id or orderNumber
  const o = ORDERS.find(x => (x.id && String(x.id) === String(idOrNumber)) || String(x._id) === String(idOrNumber) || String(x.orderNumber) === String(idOrNumber));
  if (!o) {
    alert('Order not found');
    return;
  }
  editingOrderId = o._id || o.id || o.orderNumber;
  qs('#modalTitle').textContent = `Edit Order: ${o.orderNumber || editingOrderId}`;
  qs('#orderCustomer').value = o.customerName || '';
  qs('#orderStatus').value = o.status || 'Pending';
  qs('#orderItemsBody').innerHTML = '';

  if (Array.isArray(o.items) && o.items.length){
    o.items.forEach(it => addItemRow(it));
  } else {
    addItemRow();
  }

  recalcTotals();
  showModal('orderModal');
}

function showModal(id){
  const m = qs(`#${id}`);
  if (!m) return;
  m.classList.add('show');
  m.scrollTop = 0;
  // focus first input
  setTimeout(()=> qs('#orderCustomer')?.focus(), 120);
}

function closeOrderModal(){
  qs('#orderModal')?.classList.remove('show');
  editingOrderId = null;
}

// Add a new item row; optional item object { sku, name, qty, price }
function addItemRow(item = {}){
  const tbody = qs('#orderItemsBody');
  const tr = document.createElement('tr');

  // prepare product options
  const options = PRODUCTS.map(p => `<option data-sku="${escapeHtml(p.sku)}" data-price="${Number(p.price||0)}">${escapeHtml(p.name)}${p.sku? ' ('+escapeHtml(p.sku)+')': ''}</option>`).join('');

  const qty = Number(item.qty || item.quantity || item.qtyOrdered || 1);
  const price = Number(item.price || item.unitPrice || item.price || 0);

  tr.innerHTML = `
    <td>
      <select class="product-select">
        <option value="">-- Choose product --</option>
        ${options}
      </select>
    </td>
    <td><input class="item-sku" type="text" readonly value="${escapeHtml(item.sku||'')}" /></td>
    <td><input class="item-qty" type="number" min="0" value="${qty}" /></td>
    <td><input class="item-price" type="number" step="0.01" min="0" value="${price.toFixed(2)}" /></td>
    <td class="right"><span class="line-total">RM ${(qty * price).toFixed(2)}</span></td>
    <td class="actions"><button class="inline-btn" title="Remove" onclick="this.closest('tr').remove(); recalcTotals();">‚úñÔ∏è</button></td>
  `;

  tbody.appendChild(tr);

  // if item information provided, pre-select matching product if exists
  if (item.sku || item.name) {
    const select = tr.querySelector('.product-select');
    // try find match by sku or name
    for (const opt of select.options){
      if (!opt.value) continue;
      const optSku = opt.getAttribute('data-sku') || '';
      const optText = opt.textContent || '';
      if (String(optSku) === String(item.sku) || (item.name && optText.includes(item.name))) {
        select.value = opt.value;
        break;
      }
    }
    // if no match, leave as-is but ensure SKU/price inputs are set
    tr.querySelector('.item-sku').value = item.sku || tr.querySelector('.item-sku').value;
    tr.querySelector('.item-price').value = (Number(item.price)||0).toFixed(2);
    tr.querySelector('.line-total').textContent = 'RM ' + (Number(tr.querySelector('.item-qty').value) * Number(tr.querySelector('.item-price').value)).toFixed(2);
  }

  // attach listeners
  const select = tr.querySelector('.product-select');
  const skuInput = tr.querySelector('.item-sku');
  const qtyInput = tr.querySelector('.item-qty');
  const priceInput = tr.querySelector('.item-price');

  select.addEventListener('change', () => {
    const sel = select.selectedOptions[0];
    if (!sel || !sel.dataset) return;
    const selSku = sel.dataset.sku || '';
    const selPrice = Number(sel.dataset.price || 0);
    skuInput.value = selSku;
    priceInput.value = selPrice.toFixed(2);
    updateLineTotal(tr);
    recalcTotals();
  });

  qtyInput.addEventListener('input', () => { updateLineTotal(tr); recalcTotals(); });
  priceInput.addEventListener('input', () => { updateLineTotal(tr); recalcTotals(); });

  updateLineTotal(tr);
  recalcTotals();
}

function updateLineTotal(tr){
  try {
    const qty = Number(tr.querySelector('.item-qty').value || 0);
    const price = Number(tr.querySelector('.item-price').value || 0);
    tr.querySelector('.line-total').textContent = 'RM ' + (qty * price).toFixed(2);
  } catch (err) {}
}

function collectOrderFromForm(){
  const customer = qs('#orderCustomer').value.trim();
  const status = qs('#orderStatus').value;
  const rows = Array.from(qsa('#orderItemsBody tr'));
  const items = [];

  for (const r of rows){
    const sku = r.querySelector('.item-sku')?.value?.trim() || '';
    const qty = Number(r.querySelector('.item-qty')?.value || 0);
    const price = Number(r.querySelector('.item-price')?.value || 0);
    // try get name from selected option text or PRODUCTS by sku
    let name = '';
    const sel = r.querySelector('.product-select');
    if (sel && sel.selectedOptions && sel.selectedOptions[0]) {
      name = sel.selectedOptions[0].textContent.replace(/\s*\(.+?\)\s*$/, '').trim();
    }
    if (!name && sku) {
      const prod = PRODUCTS.find(p => p.sku === sku);
      if (prod) name = prod.name;
    }
    if (qty <= 0) continue; // skip zero qty items
    items.push({ sku, name, qty, price });
  }

  const subtotal = items.reduce((s,it) => s + (Number(it.qty||0) * Number(it.price||0)), 0);
  const companyTax = 0; // tax can be loaded from company API if you want; backend will compute if needed.
  const total = subtotal + (subtotal * companyTax / 100);

  return { customerName: customer, status, items, total, subtotal };
}

async function saveOrder(){
  const payload = collectOrderFromForm();
  if (!payload.customerName) return alert('Please enter customer name.');
  if (!payload.items.length) return alert('Please add at least one item with qty > 0.');

  try {
    if (editingOrderId) {
      // PUT /api/orders/:id
      const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(editingOrderId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customerName: payload.customerName,
          status: payload.status,
          items: payload.items,
          total: payload.total
        })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({message:'Update failed'}));
        return alert('Failed to update order: ' + (err.message || ''));
      }
      alert('Order updated.');
    } else {
      // POST /api/orders
      const res = await fetch(`${API_BASE}/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customerName: payload.customerName,
          status: payload.status,
          items: payload.items,
          total: payload.total
        })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({message:'Create failed'}));
        return alert('Failed to create order: ' + (err.message || ''));
      }
      alert('Order created.');
    }

    closeOrderModal();
    await loadOrders();
  } catch (err) {
    console.error('saveOrder error', err);
    alert('Server error while saving order.');
  }
}

// recalc only totals in modal
function recalcTotals(){
  const rows = Array.from(qsa('#orderItemsBody tr'));
  let subtotal = 0;
  rows.forEach(r => {
    const qty = Number(r.querySelector('.item-qty')?.value || 0);
    const price = Number(r.querySelector('.item-price')?.value || 0);
    subtotal += qty * price;
  });
  const taxPct = 0; // Optionally fetch company.taxPercent from /api/company for dynamic tax
  const taxAmount = subtotal * (taxPct/100);
  const grand = subtotal + taxAmount;
  qs('#subtotalText').textContent = 'RM ' + subtotal.toFixed(2);
  qs('#taxText').textContent = taxPct + '%';
  qs('#grandTotalText').textContent = 'RM ' + grand.toFixed(2);
}

// ------------------ VIEW / DELETE ------------------
function viewInvoice(idOrOrderNumber){
  // open invoice PDF endpoint
  window.open(`${API_BASE}/orders/${encodeURIComponent(idOrOrderNumber)}/invoice`, '_blank');
}

async function deleteOrderConfirmed(idOrOrderNumber){
  if (!confirm('Are you sure you want to delete this order?')) return;
  try {
    const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(idOrOrderNumber)}`, { method: 'DELETE' });
    if (!res.ok) {
      const err = await res.json().catch(()=>({ message: 'Delete failed' }));
      return alert('Failed to delete order: ' + (err.message || ''));
    }
    alert('Order deleted.');
    await loadOrders();
  } catch (err) {
    console.error('deleteOrder error', err);
    alert('Server error while deleting order.');
  }
}

// ------------------ helpers ------------------
function escapeHtml(s){ return s ? String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) : ''; }

</script>
</body>
</html>
