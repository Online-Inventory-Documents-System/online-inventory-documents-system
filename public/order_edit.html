<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edit Order | Inventory System</title>
<link rel="stylesheet" href="css/style.css"/>
<style>
  .order-item-row { display:flex; gap:8px; margin-bottom:10px; }
  .order-item-row input, select { padding:8px; border:1px solid var(--border-color); border-radius:6px; flex:1; }
  .remove-item-btn { background:#d9534f; color:white; padding:8px; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>

<body>
<header>
  <h1>âœï¸ Edit Order</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="orders.html">Orders</a>
    <button onclick="toggleTheme()">ğŸŒ“ Mode</button>
    <button onclick="logout()">ğŸšª Logout</button>
    <div id="adminInfo">Logged in as: <span id="adminName"></span> (<span id="adminRole"></span>)</div>
  </nav>
</header>

<section>
  <h2 id="pageTitle">Create Order</h2>

  <form id="orderForm">
    <input type="hidden" id="orderId"/>

    <label>Customer Name</label>
    <input type="text" id="customerName" required/>

    <label>Order Status</label>
    <select id="orderStatus">
      <option value="Pending">Pending</option>
      <option value="Approved">Approved</option>
      <option value="Cancelled">Cancelled</option>
    </select>

    <h3>Order Items</h3>
    <div id="itemsContainer"></div>

    <button type="button" id="addItemBtn" class="secondary-btn">+ Add Item</button>

    <h3>Total: RM <span id="orderTotal">0.00</span></h3>

    <div style="margin-top:20px; display:flex; gap:10px;">
      <button id="saveOrderBtn" type="button" class="primary-btn" style="flex:1;">ğŸ’¾ Save Order</button>
      <button id="cancelEditBtn" type="button" class="secondary-btn" style="flex:1;">âœ– Cancel</button>
    </div>

    <p id="orderMessage" style="margin-top:12px;"></p>
  </form>
</section>

<script src="js/setting.js" defer></script>
<script src="js/script.js" defer></script>

<script>
document.documentElement.dataset.page = "order_edit";

document.addEventListener("DOMContentLoaded", () => {
  const adminName = sessionStorage.getItem("adminName") || "Guest";
  const adminRole = sessionStorage.getItem("adminRole") || "User";

  document.getElementById("adminName").textContent = adminName;
  document.getElementById("adminRole").textContent = adminRole;

  const orderId = new URLSearchParams(window.location.search).get("id");
  if (orderId) loadOrderForEdit(orderId);

  document.getElementById("addItemBtn").addEventListener("click", addItemRow);
  document.getElementById("cancelEditBtn").addEventListener("click", () => {
    window.location.href = "orders.html";
  });

  document.getElementById("saveOrderBtn").addEventListener("click", saveOrder);
});

// Add empty row
function addItemRow(item = null) {
  const div = document.createElement("div");
  div.className = "order-item-row";

  div.innerHTML = `
    <input type="text" class="item-name" placeholder="Item name" value="${item?.name || ""}" required />
    <input type="number" class="item-qty" placeholder="Qty" min="1" value="${item?.qty || 1}" required />
    <input type="number" class="item-price" placeholder="Unit Price" step="0.01" value="${item?.price || 0}" required />
    <button type="button" class="remove-item-btn">ğŸ—‘</button>
  `;

  div.querySelector(".remove-item-btn").onclick = () => {
    div.remove();
    recalcTotal();
  };

  div.oninput = recalcTotal;

  document.getElementById("itemsContainer").appendChild(div);

  recalcTotal();
}

function recalcTotal() {
  let total = 0;
  document.querySelectorAll(".order-item-row").forEach(row => {
    const qty = parseFloat(row.querySelector(".item-qty").value || 0);
    const price = parseFloat(row.querySelector(".item-price").value || 0);
    total += qty * price;
  });
  document.getElementById("orderTotal").textContent = total.toFixed(2);
}

async function loadOrderForEdit(id) {
  document.getElementById("pageTitle").textContent = "Edit Order";

  const res = await fetch(`${API_BASE}/orders/${id}`);
  const order = await res.json();

  document.getElementById("orderId").value = order._id;
  document.getElementById("customerName").value = order.customer;
  document.getElementById("orderStatus").value = order.status;

  order.items.forEach(it => addItemRow(it));
  recalcTotal();
}

async function saveOrder() {
  const id = document.getElementById("orderId").value;
  const customer = document.getElementById("customerName").value;
  const status = document.getElementById("orderStatus").value;

  const items = [];
  document.querySelectorAll(".order-item-row").forEach(row => {
    items.push({
      name: row.querySelector(".item-name").value,
      qty: parseInt(row.querySelector(".item-qty").value),
      price: parseFloat(row.querySelector(".item-price").value)
    });
  });

  const payload = { customer, status, items };

  const url = id ? `${API_BASE}/orders/${id}` : `${API_BASE}/orders`;
  const method = id ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const msg = document.getElementById("orderMessage");
  if (res.ok) {
    msg.textContent = "Order saved successfully!";
    msg.style.color = "green";
    setTimeout(() => window.location.href = "orders.html", 800);
  } else {
    msg.textContent = "Error saving order.";
    msg.style.color = "red";
  }
}
</script>

</body>
</html>
